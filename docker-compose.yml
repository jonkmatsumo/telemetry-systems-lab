services:
  telemetry-api:
    build:
      context: .
      target: runtime
    container_name: telemetry_api
    env_file: .env
    environment:
      DB_CONNECTION_STRING: "postgresql://postgres:password@postgres:${DB_PORT_INTERNAL}/telemetry"
      GRPC_GENERATOR_TARGET: "telemetry-generator:${GRPC_PORT_INTERNAL}"
    ports:
      - "${API_HTTP_PORT}:${API_HTTP_PORT_INTERNAL}"
    networks:
      - telemetry_net
    depends_on:
      - telemetry-generator

  telemetry-generator:
    build:
      context: .
      target: runtime
    container_name: telemetry_generator
    command: ["./telemetry-generator"]
    env_file: .env
    environment:
      DB_CONNECTION_STRING: "postgresql://postgres:password@postgres:${DB_PORT_INTERNAL}/telemetry"
      SERVER_ADDRESS: "0.0.0.0:${GRPC_PORT_INTERNAL}"
    ports:
      - "${GRPC_PORT}:${GRPC_PORT_INTERNAL}"
    networks:
      - telemetry_net
    # Healthcheck dep is runtime specific, usually handled by orchestration or reliance on retries.
    # We remove explicit depends_on: condition: service_healthy because infra is now external.

networks:
  telemetry_net:
    driver: bridge
