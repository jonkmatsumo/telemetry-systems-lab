services:
  telemetry-generator:
    build:
      context: .
      target: dev
    container_name: telemetry_generator_dev
    command: [ "sh", "-c", "cmake -B build -S . && make -C build -j$$(nproc) all && ./build/telemetry-generator" ]
    env_file: .env
    environment:
      DB_CONNECTION_STRING: "postgresql://postgres:password@postgres:${DB_PORT_INTERNAL}/telemetry"
      SERVER_ADDRESS: "0.0.0.0:${GRPC_PORT_INTERNAL}"
    volumes:
      - ./src:/app/src
      - ./proto:/app/proto
      - ./tests:/app/tests
      - ./CMakeLists.txt:/app/CMakeLists.txt
      - build_cache:/app/build
    networks:
      - telemetry_net

  telemetry-api:
    build:
      context: .
      target: dev
    container_name: telemetry_api_dev
    command: [ "sh", "-c", "while [ ! -f ./build/telemetry-api ]; do echo 'Waiting for build...'; sleep 2; done; ./build/telemetry-api" ]
    env_file: .env
    environment:
      DB_CONNECTION_STRING: "postgresql://postgres:password@postgres:${DB_PORT_INTERNAL}/telemetry"
      GRPC_GENERATOR_TARGET: "telemetry-generator:${GRPC_PORT_INTERNAL}"
      API_PORT: ${API_HTTP_PORT_INTERNAL}
    ports:
      - "${API_HTTP_PORT}:${API_HTTP_PORT_INTERNAL}"
    volumes:
      - ./src:/app/src
      - ./proto:/app/proto
      - ./tests:/app/tests
      - ./CMakeLists.txt:/app/CMakeLists.txt
      - build_cache:/app/build
    networks:
      - telemetry_net

  web-ui:
    build:
      context: .
      target: dev-web
    container_name: telemetry_web_ui_dev
    # Note: flutter run requires an interactive terminal usually, 
    # but we can use web-server mode for headless serving.
    command: [ "sh", "-c", "cd web_ui && flutter pub get && flutter build web --dart-define=API_BASE_URL=${API_BASE_URL_HOST} && python3 -m http.server ${UI_PORT} --directory build/web --bind 0.0.0.0" ]
    env_file: .env
    ports:
      - "${UI_PORT}:${UI_PORT}"
    volumes:
      - ./web_ui:/home/flutteruser/web_ui
    networks:
      - telemetry_net

networks:
  telemetry_net:
    driver: bridge

volumes:
  build_cache:
